name: Deploy to Hugging Face

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 */2 * * *'

  # å½“ Uptime Kuma API å‘é€ 'service-down-alert' äº‹ä»¶æ—¶è§¦å‘æ­¤å·¥ä½œæµã€‚
  repository_dispatch:
    types: [service-down-alert]

jobs:
  deploy-and-sync:
    runs-on: ubuntu-latest
    
    env:
      HF_USER: ${{ secrets.HF_USER }}
      HF_SPACE: ${{ secrets.HF_SPACE }}
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      UUID: ${{ secrets.UUID }}
      NEZHA_SERVER: ${{ secrets.NEZHA_SERVER }}
      NEZHA_PORT: ${{ secrets.NEZHA_PORT }}
      NEZHA_KEY: ${{ secrets.NEZHA_KEY }}
      ARGO_DOMAIN: ${{ secrets.ARGO_DOMAIN }}
      ARGO_AUTH: ${{ secrets.ARGO_AUTH }}
      CFIP: ${{ secrets.CFIP }}
      CFPORT: ${{ secrets.CFPORT }}
      NAME: ${{ secrets.NAME }}
      UPLOAD_URL: ${{ secrets.UPLOAD_URL }}
      PROJECT_URL: ${{ secrets.PROJECT_URL }}
      AUTO_ACCESS: ${{ secrets.AUTO_ACCESS }}
      FILE_PATH: ${{ secrets.FILE_PATH }}
      SUB_PATH: ${{ secrets.SUB_PATH }}
      PORT: ${{ secrets.PORT }}
      ARGO_PORT: ${{ secrets.ARGO_PORT }}

    steps:
      - name: Check Trigger Event
        run: |
          echo "Workflow triggered by: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "è§¦å‘äº‹ä»¶ç±»åž‹ (Event Type): ${{ github.event.action }}"
            echo "æ”¶åˆ°æ¥è‡ª Uptime Kuma çš„ä¸‹çº¿é€šçŸ¥ï¼Œå¼€å§‹æ‰§è¡Œè‡ªåŠ¨æ¢å¤éƒ¨ç½²æµç¨‹..."
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "å·¥ä½œæµè¢«æ‰‹åŠ¨è§¦å‘ï¼Œå¼€å§‹æ‰§è¡Œéƒ¨ç½²..."
          else
            echo "å·¥ä½œæµç”±è®¡åˆ’ä»»åŠ¡è§¦å‘ï¼Œå¼€å§‹æ‰§è¡Œéƒ¨ç½²..."
          fi

      - name: Install Git LFS
        run: |
          sudo apt-get update
          sudo apt-get install git-lfs -y

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: 'main'
          fetch-depth: 0
          lfs: true

      - name: Recreate Hugging Face Space via Python
        run: |
          pip install "huggingface_hub>=0.20.0"

          cat << 'EOF' > manage_space.py
          import os
          import sys
          import time
          from huggingface_hub import HfApi
          from huggingface_hub.utils import RepositoryNotFoundError, HfHubHTTPError

          def main():
              # ä»ŽçŽ¯å¢ƒå˜é‡ä¸­è¯»å–ç”¨æˆ·åå’Œ Space å
              hf_user = os.environ.get("HF_USER")
              hf_space = os.environ.get("HF_SPACE")
              token = os.environ.get("HF_TOKEN")
              
              # ç¡®ä¿æœºå¯†å·²è®¾ç½®
              if not hf_user or not hf_space or not token:
                  print("--- [Pythonè„šæœ¬] é”™è¯¯ï¼šHF_USER, HF_SPACE, æˆ– HF_TOKEN çŽ¯å¢ƒå˜é‡æœªè®¾ç½®ï¼")
                  print("--- [Pythonè„šæœ¬] è¯·æ£€æŸ¥æ‚¨ GitHub ä»“åº“çš„ Secrets é…ç½®ã€‚")
                  sys.exit(1)
              
              repo_id = f"{hf_user}/{hf_space}"
              
              print(f"--- [Pythonè„šæœ¬] å‡†å¤‡è¿›è¡Œå…¨æ–°éƒ¨ç½² ---")
              print(f"--- [Pythonè„šæœ¬] ç›®æ ‡Space: {repo_id}")

              try:
                  api = HfApi(token=token)
                  print("--- [Pythonè„šæœ¬] HfApiå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸã€‚")

                  # --- åˆ é™¤æ“ä½œ ---
                  print("\n--- [Pythonè„šæœ¬] æ­¥éª¤1: æ­£åœ¨å°è¯•åˆ é™¤æ—§çš„Space...")
                  try:
                      api.repo_info(repo_id=repo_id, repo_type="space")
                      print(f"--- [Pythonè„šæœ¬] å‘çŽ°å·²å­˜åœ¨çš„Space '{repo_id}'ã€‚æ­£åœ¨å‘é€åˆ é™¤è¯·æ±‚...")
                      api.delete_repo(repo_id=repo_id, repo_type="space")
                      print(f"--- [Pythonè„šæœ¬] åˆ é™¤è¯·æ±‚å·²å‘é€ã€‚ç­‰å¾…10ç§’ä»¥ç¡®ä¿åŽå°å®Œæˆæ“ä½œ...")
                      time.sleep(10)
                  except RepositoryNotFoundError:
                      print(f"--- [Pythonè„šæœ¬] Space '{repo_id}' ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤ã€‚")
                  
                  # --- åˆ›å»ºæ“ä½œ ---
                  print("\n--- [Pythonè„šæœ¬] æ­¥éª¤2: æ­£åœ¨åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å…è´¹ç‰ˆSpace...")
                  api.create_repo(
                      repo_id=repo_id,
                      repo_type="space",
                      space_sdk="docker",
                      space_hardware="cpu-basic",
                      private=False,
                  )
                  print(f"--- [Pythonè„šæœ¬] æˆåŠŸåˆ›å»ºå…¨æ–°çš„Space: {repo_id}")

              except HfHubHTTPError as e:
                  print(f"--- [Pythonè„šæœ¬] å‘ç”Ÿè‡´å‘½APIé”™è¯¯ï¼---")
                  print(f"è¯·ç«‹å³æ£€æŸ¥æ‚¨çš„ HF_TOKEN æ˜¯å¦æ‹¥æœ‰ 'write' æƒé™ã€‚")
                  print(f"è¯¦ç»†é”™è¯¯: {e}")
                  sys.exit(1)
              except Exception as e:
                  print(f"--- [Pythonè„šæœ¬] å‘ç”ŸæœªçŸ¥é”™è¯¯: {e}")
                  sys.exit(1)

          if __name__ == "__main__":
              main()
          EOF

          python manage_space.py

      - name: Create README.md for Space configuration
        run: |
          echo "---
          title: ${HF_SPACE}
          emoji: ðŸš€
          colorFrom: blue
          colorTo: green
          sdk: docker
          app_port: 3000
          ---
          " > README.md

      - name: Inject secrets into Dockerfile
        run: |
          sed -i "s|__UUID__|${UUID}|g" Dockerfile
          sed -i "s|__NEZHA_SERVER__|${NEZHA_SERVER}|g" Dockerfile
          sed -i "s|__NEZHA_PORT__|${NEZHA_PORT}|g" Dockerfile
          sed -i "s|__NEZHA_KEY__|${NEZHA_KEY}|g" Dockerfile
          sed -i "s|__ARGO_DOMAIN__|${ARGO_DOMAIN}|g" Dockerfile
          sed -i "s|__ARGO_AUTH__|${ARGO_AUTH}|g" Dockerfile
          sed -i "s|__CFIP__|${CFIP}|g" Dockerfile
          sed -i "s|__CFPORT__|${CFPORT}|g" Dockerfile
          sed -i "s|__NAME__|${NAME}|g" Dockerfile
          sed -i "s|__UPLOAD_URL__|${UPLOAD_URL}|g" Dockerfile
          sed -i "s|__PROJECT_URL__|${PROJECT_URL}|g" Dockerfile
          sed -i "s|__AUTO_ACCESS__|${AUTO_ACCESS}|g" Dockerfile
          sed -i "s|__FILE_PATH__|${FILE_PATH}|g" Dockerfile
          sed -i "s|__SUB_PATH__|${SUB_PATH}|g" Dockerfile
          sed -i "s|__PORT__|${PORT}|g" Dockerfile
          sed -i "s|__ARGO_PORT__|${ARGO_PORT}|g" Dockerfile
          
      - name: Commit and Push to new HF Space
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git rm --cached -r .github --ignore-unmatch
          git add Dockerfile README.md
          git commit --amend --no-edit
          git lfs install
          
          REMOTE_URL="https://user:${HF_TOKEN}@huggingface.co/spaces/${HF_USER}/${HF_SPACE}"
          git remote add space "${REMOTE_URL}"
          git push --force space HEAD:main
