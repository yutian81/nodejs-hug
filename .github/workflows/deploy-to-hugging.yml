name: Deploy to Hugging Face

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'
  # push:
  #   branches:
  #     - main

jobs:
  deploy-and-sync:
    runs-on: ubuntu-latest
    
    env:
      HF_USER: ${{ secrets.HF_USER }}
      HF_SPACE: ${{ secrets.HF_SPACE }}
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      UUID: ${{ secrets.UUID }}
      NEZHA_SERVER: ${{ secrets.NEZHA_SERVER }}
      NEZHA_PORT: ${{ secrets.NEZHA_PORT }}
      NEZHA_KEY: ${{ secrets.NEZHA_KEY }}
      ARGO_DOMAIN: ${{ secrets.ARGO_DOMAIN }}
      ARGO_AUTH: ${{ secrets.ARGO_AUTH }}
      CFIP: ${{ secrets.CFIP }}
      CFPORT: ${{ secrets.CFPORT }}
      NAME: ${{ secrets.NAME }}
      UPLOAD_URL: ${{ secrets.UPLOAD_URL }}
      PROJECT_URL: ${{ secrets.PROJECT_URL }}
      AUTO_ACCESS: ${{ secrets.AUTO_ACCESS }}
      FILE_PATH: ${{ secrets.FILE_PATH }}
      SUB_PATH: ${{ secrets.SUB_PATH }}
      PORT: ${{ secrets.PORT }}
      ARGO_PORT: ${{ secrets.ARGO_PORT }}

    steps:
      - name: Install Git LFS
        run: |
          sudo apt-get update
          sudo apt-get install git-lfs -y

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: 'main'
          fetch-depth: 0
          lfs: true

      - name: Recreate Hugging Face Space for a Clean Deploy
        run: |
          if [ -z "${HF_USER}" ] || [ -z "${HF_SPACE}" ]; then
            echo "é”™è¯¯ï¼šHF_USER æˆ– HF_SPACE æœºå¯†æœªåœ¨ GitHub ä»“åº“ä¸­è®¾ç½®ï¼"
            echo "è¯·è¿›å…¥æ‚¨ä»“åº“çš„ 'Settings' -> 'Secrets and variables' -> 'Actions' é¡µé¢ï¼Œ"
            echo "å¹¶ç¡®ä¿ HF_USER å’Œ HF_SPACE è¿™ä¸¤ä¸ªæœºå¯†éƒ½å·²åˆ›å»ºä¸”åŒ…å«æ­£ç¡®çš„å€¼ã€‚"
            exit 1
          fi
          
          SPACE_ID="${HF_USER}/${HF_SPACE}"
          DELETE_API_URL="https://huggingface.co/api/spaces/${SPACE_ID}"
          CREATE_API_URL="https://huggingface.co/api/repos/create"
          
          echo "--- å‡†å¤‡è¿›è¡Œå…¨æ–°éƒ¨ç½² ---"
          echo "ç›®æ ‡Space: ${SPACE_ID}"

          echo "æ­¥éª¤1: åˆ é™¤æ—§çš„Space (å¹¶æ£€æŸ¥ç»“æžœ)..."
          DELETE_RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE -H "Authorization: Bearer ${HF_TOKEN}" "${DELETE_API_URL}")
          DELETE_HTTP_CODE=$(echo "$DELETE_RESPONSE" | tail -n1)
          DELETE_BODY=$(echo "$DELETE_RESPONSE" | sed '$d')

          # åªæœ‰åœ¨æˆåŠŸ(200)æˆ–æœ¬å°±ä¸å­˜åœ¨(404)æ—¶æ‰ç»§ç»­
          if [ "$DELETE_HTTP_CODE" -eq 200 ] || [ "$DELETE_HTTP_CODE" -eq 404 ]; then
            echo "æ—§çŽ¯å¢ƒæ¸…ç†æˆåŠŸ (çŠ¶æ€ç : ${DELETE_HTTP_CODE})ã€‚"
          else
            echo "é”™è¯¯ï¼šåˆ é™¤æ—§Spaceå¤±è´¥ï¼ HTTPçŠ¶æ€ç : ${DELETE_HTTP_CODE}"
            echo "APIå“åº”: ${DELETE_BODY}"
            echo "è¯·æ£€æŸ¥æ‚¨çš„ HF_TOKEN æ˜¯å¦æœ‰ 'write' æƒé™ï¼"
            exit 1
          fi

          sleep 10

          echo "æ­¥éª¤2: åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å…è´¹ç‰ˆSpace..."
          CREATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${HF_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"repoId\":\"${SPACE_ID}\",\"repoType\":\"space\",\"private\":false}" \
            "${CREATE_API_URL}")
          
          HTTP_CODE=$(echo "$CREATE_RESPONSE" | tail -n1)
          BODY=$(echo "$CREATE_RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
            echo "æˆåŠŸåˆ›å»ºå…¨æ–°çš„Space: ${SPACE_ID}"
          else
            echo "é”™è¯¯ï¼šåˆ›å»ºSpaceå¤±è´¥ï¼ HTTPçŠ¶æ€ç : ${HTTP_CODE}"
            echo "APIå“åº”: ${BODY}"
            exit 1
          fi

      - name: Create README.md for Space configuration
        run: |
          echo "---
          title: ${HF_SPACE}
          emoji: ðŸš€
          colorFrom: blue
          colorTo: green
          sdk: docker
          app_port: 3000
          ---
          " > README.md

      - name: Inject secrets into Dockerfile
        run: |
          sed -i "s|__UUID__|${UUID}|g" Dockerfile
          sed -i "s|__NEZHA_SERVER__|${NEZHA_SERVER}|g" Dockerfile
          sed -i "s|__NEZHA_PORT__|${NEZHA_PORT}|g" Dockerfile
          sed -i "s|__NEZHA_KEY__|${NEZHA_KEY}|g" Dockerfile
          sed -i "s|__ARGO_DOMAIN__|${ARGO_DOMAIN}|g" Dockerfile
          sed -i "s|__ARGO_AUTH__|${ARGO_AUTH}|g" Dockerfile
          sed -i "s|__CFIP__|${CFIP}|g" Dockerfile
          sed -i "s|__CFPORT__|${CFPORT}|g" Dockerfile
          sed -i "s|__NAME__|${NAME}|g" Dockerfile
          sed -i "s|__UPLOAD_URL__|${UPLOAD_URL}|g" Dockerfile
          sed -i "s|__PROJECT_URL__|${PROJECT_URL}|g" Dockerfile
          sed -i "s|__AUTO_ACCESS__|${AUTO_ACCESS}|g" Dockerfile
          sed -i "s|__FILE_PATH__|${FILE_PATH}|g" Dockerfile
          sed -i "s|__SUB_PATH__|${SUB_PATH}|g" Dockerfile
          sed -i "s|__PORT__|${PORT}|g" Dockerfile
          sed -i "s|__ARGO_PORT__|${ARGO_PORT}|g" Dockerfile
          
      - name: Commit and Push to new HF Space
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git rm --cached -r .github --ignore-unmatch
          git add Dockerfile README.md
          git commit --amend --no-edit
          git lfs install
          REMOTE_URL="https://user:${HF_TOKEN}@huggingface.co/spaces/${HF_USER}/${HF_SPACE}"
          git remote add space "${REMOTE_URL}"
          git push --force space HEAD:main
